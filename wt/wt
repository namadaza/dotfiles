#!/bin/bash

set -euo pipefail

usage() {
    echo "Usage:"
    echo "  wt add <branch>       Create worktree + tmux session"
    echo "  wt add --pr <number>  Create worktree from a PR branch"
    echo "  wt remove             Tear down current worktree + session"
    echo "  wt list               List active worktree sessions"
    echo "  wt prune              Remove prunable worktrees and their branches"
    echo "  wt --help             Show this help message"
    exit "${1:-1}"
}

require_git_repo() {
    if ! git rev-parse --show-toplevel &>/dev/null; then
        echo "Error: not inside a git repository" >&2
        exit 1
    fi
}

setup_tmux_session() {
    local branch="$1"
    local worktree_path="$2"

    tmux new-session -d -s "$branch" -c "$worktree_path"
    tmux new-window -t "$branch" -c "$worktree_path"
    tmux new-window -t "$branch" -c "$worktree_path"
    tmux select-window -t "$branch:1"

    if [ -n "${TMUX:-}" ]; then
        tmux switch-client -t "$branch"
    else
        tmux attach -t "$branch"
    fi
}

cmd_add() {
    local pr_number=""
    local branch=""

    while [ $# -gt 0 ]; do
        case "$1" in
            --pr)
                [ $# -lt 2 ] && usage
                pr_number="$2"
                shift 2
                ;;
            *)
                branch="$1"
                shift
                ;;
        esac
    done

    if [ -z "$branch" ] && [ -z "$pr_number" ]; then
        usage
    fi

    require_git_repo
    local project_root
    project_root="$(git rev-parse --show-toplevel)"

    if [[ "$project_root" == *__worktrees/* ]]; then
        echo "Error: already inside a worktree. Cannot nest worktrees." >&2
        exit 1
    fi

    local project_name
    project_name="$(basename "$project_root")"

    if [ -n "$pr_number" ]; then
        branch="$(gh pr view "$pr_number" --json headRefName -q .headRefName)"
        git fetch origin "$branch"
        local worktree_path="$project_root/../${project_name}__worktrees/$branch"
        if git show-ref --verify --quiet "refs/heads/$branch"; then
            git branch -f "$branch" "origin/$branch"
            git worktree add "$worktree_path" "$branch"
        else
            git worktree add --track -b "$branch" "$worktree_path" "origin/$branch"
        fi
    else
        local worktree_path="$project_root/../${project_name}__worktrees/$branch"
        git worktree add -b "$branch" "$worktree_path"
    fi

    setup_tmux_session "$branch" "$worktree_path"
}

cmd_remove() {
    require_git_repo
    local worktree_path
    worktree_path="$(git rev-parse --show-toplevel)"

    if [[ "$worktree_path" != *__worktrees/* ]]; then
        echo "Error: not inside a worktree (__worktrees/ directory). Refusing to remove." >&2
        exit 1
    fi

    local session
    session="$(tmux display-message -p '#S')"

    tmux kill-session -t "$session"
    # Structure: <parent>/<project>__worktrees/<branch>
    local worktrees_dir
    worktrees_dir="$(dirname "$worktree_path")"
    local project_name
    project_name="$(basename "$worktrees_dir" | sed 's/__worktrees$//')"
    local parent_dir
    parent_dir="$(dirname "$worktrees_dir")"
    git -C "$parent_dir/$project_name" worktree remove "$worktree_path"
}

cmd_list() {
    require_git_repo
    local project_root
    project_root="$(git rev-parse --show-toplevel)"

    echo "Worktrees:"
    git -C "$project_root" worktree list
}

cmd_prune() {
    require_git_repo
    local project_root
    project_root="$(git rev-parse --show-toplevel)"

    local prunable
    prunable="$(git -C "$project_root" worktree list --porcelain | awk '/^worktree /{wt=$2} /^prunable/{print wt}')"

    if [ -z "$prunable" ]; then
        echo "No prunable worktrees found."
        return
    fi

    echo "Pruning worktrees:"
    while IFS= read -r wt_path; do
        local branch
        branch="$(basename "$wt_path")"
        echo "  removing: $wt_path (branch: $branch)"
        git -C "$project_root" worktree remove --force "$wt_path"
        git -C "$project_root" branch -D "$branch" 2>/dev/null || true
    done <<< "$prunable"

    echo "Done."
}

# --- main ---

if [ $# -eq 0 ]; then
    usage
fi

case "$1" in
    add)
        shift
        cmd_add "$@"
        ;;
    remove)
        cmd_remove
        ;;
    list)
        cmd_list
        ;;
    prune)
        cmd_prune
        ;;
    -h|--help|help)
        usage 0
        ;;
    *)
        usage
        ;;
esac
